#!/bin/bash -ex

exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1

date '+%Y-%m-%d %H:%M:%S'

echo "installing YUM repo"
rpm -ivh http://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm


yum -y install wget  
yum -y install unzip 
yum -y install puppet 

echo "172.31.35.111	puppet.us-west-2.compute.internal	puppet" >> /etc/hosts
echo "server = puppet.us-west-2.compute.internal" >>  /etc/puppet/puppet.conf
echo "PUPPET_SERVER=puppet.us-west-2.compute.internal" > /etc/sysconfig/puppet


echo "Installing Oracle JDK & JCE policy setup"
date '+%Y-%m-%d %H:%M:%S'

wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie"  http://download.oracle.com/otn-pub/java/jdk/8u31-b13/jdk-8u31-linux-x64.rpm

rpm -ivh jdk-8u31-linux-x64.rpm
for i in `rpm -qa | grep java`; do yum -y remove $i ; done
rpm -qa | grep jdk | xargs rpm -ql | grep bin/java$ | grep -v jre | awk -F'bin' '{print $1}'
alternatives --install /usr/bin/java java /usr/java/jdk1.8.0_31/bin/java 1
alternatives --install /usr/bin/javac javac /usr/java/jdk1.8.0_31/bin/javac 1
alternatives --install /usr/bin/javaws  javaws /usr/java/jdk1.8.0_31/bin/javaws 1
alternatives --install /usr/bin/jar  jar /usr/java/jdk1.8.0_31/bin/jar 1
alternatives --set java /usr/java/jdk1.8.0_31/bin/java
alternatives --set javac /usr/java/jdk1.8.0_31/bin/javac
alternatives --set  javaws /usr/java/jdk1.8.0_31/bin/javaws
alternatives --set jar /usr/java/jdk1.8.0_31/bin/jar
alternatives --auto  java
alternatives --auto  javac
alternatives --auto  javaws
alternatives --auto  jar

JDK=`rpm -qa | grep jdk | xargs rpm -ql | grep bin/java$ | grep -v jre | awk -F'bin' '{print $1}'`
echo "export JAVA_HOME=$JDK" > /etc/profile.d/jdk.sh
echo "export PATH=$JAVA_HOME/bin:$PATH" >> /etc/profile.d/jdk.sh
source /etc/profile.d/jdk.sh
echo $JAVA_HOME

wget --no-check-certificate --no-cookies --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip

rm -rf ~/UnlimitedJCEPolicyJDK8/
unzip jce_policy-8.zip -d ~/

rm -f $JAVA_HOME/jre/lib/security/local_policy.jar
rm -f $JAVA_HOME/jre/lib/security/US_export_policy.jar

mv -v ~/UnlimitedJCEPolicyJDK8/local_policy.jar $JAVA_HOME/jre/lib/security/ 
mv -v ~/UnlimitedJCEPolicyJDK8/US_export_policy.jar $JAVA_HOME/jre/lib/security/

systemctl enable puppet
systemctl start puppet

init 6
